<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Signature Editor v2 – Placeholders, Selective Strip, Replace Links</title>
  <style>
    :root { --bg:#0b0c10; --fg:#e8e8ea; --muted:#a2a2aa; --accent:#7aa2f7; --panel:#15151c; --border:#23232d; }
    html,body{height:100%}
    body{margin:0;font:14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, sans-serif;background:var(--bg);color:var(--fg)}
    .wrap{max-width:1000px;margin:32px auto;padding:0 16px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;background:var(--panel);border:1px solid var(--border);border-bottom:none;border-radius:12px 12px 0 0;padding:12px}
    .btn{appearance:none;border:1px solid var(--border);background:#0f1016;color:var(--fg);padding:8px 10px;border-radius:9px;cursor:pointer}
    .btn:hover{border-color:#3b3c4d}
    .btn.primary{border-color:#3b4b84;background:#0e1330}
    .sep{width:1px;height:28px;background:var(--border);margin:0 6px}
    .editor{min-height:280px;background:#0f1016;border:1px solid var(--border);border-radius:0 0 12px 12px;padding:16px;outline:none}
    .editor img{display:block;border:0;outline:0;text-decoration:none;-ms-interpolation-mode:bicubic}
    .placeholder{display:block;box-sizing:border-box;background:repeating-linear-gradient(45deg, #1b1c25 0 10px, #161821 10px 20px);border:1px dashed #444;color:#c9c9cf;padding:6px;font:12px/1.2 Arial, Helvetica, sans-serif;text-align:center}
    .placeholder .meta{opacity:.8;font-size:11px}
    .small{font-size:12px;color:var(--muted)}
    #htmlView{width:100%;height:280px;resize:vertical;background:#0f1016;color:var(--fg);border:1px solid var(--border);border-radius:0 0 12px 12px;padding:16px}
    .hidden{display:none}
    .status{color:var(--muted);font-size:12px;margin-top:8px}

    /* Drawer */
    .drawer{position:fixed;inset:auto 0 0 0;background:var(--panel);border-top:1px solid var(--border);transform:translateY(100%);transition:transform .25s ease;box-shadow:0 -12px 40px rgba(0,0,0,.5)}
    .drawer.open{transform:translateY(0)}
    .drawer .head{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border)}
    .drawer .body{max-height:40vh;overflow:auto;padding:12px 16px}
    .imgrow{display:grid;grid-template-columns:64px 1fr auto;gap:12px;align-items:center;padding:8px 0;border-bottom:1px solid #1f2030}
    .thumb{width:64px;height:48px;object-fit:contain;background:#0f1016;border:1px solid #1f2030;border-radius:6px}
    .field{display:flex;gap:6px;align-items:center}
    input[type="url"],input[type="text"],input[type="number"]{background:#0f1016;border:1px solid #2a2b36;border-radius:8px;color:var(--fg);padding:6px 8px;width:100%}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 style="margin:0 0 10px">Signature Editor v2</h1>
    <p class="small" style="margin:0 0 14px">Adds real placeholders that preserve dimensions, lets you strip specific images, and replace embedded sources with new links without changing size.</p>

    <div class="toolbar" role="toolbar">
      <button class="btn" id="btnStripAll">Strip all → placeholders</button>
      <button class="btn" id="btnImagesPanel">Manage images…</button>
      <span class="sep"></span>
      <button class="btn" id="btnToggle">Toggle HTML view</button>
      <button class="btn" id="btnExport">Export HTML</button>
      <button class="btn" id="btnSimplify">Simplify styles</button>
    </div>

    <div id="editor" class="editor" contenteditable="true">
      <table cellpadding="0" cellspacing="0" role="presentation" style="border-collapse:collapse"><tr>
        <td style="font:14px/1.35 Arial, Helvetica, sans-serif;color:#222">
          <div style="font-weight:700">Your Name</div>
          <div style="color:#666">Title · Company</div>
          <div>
            <img src="cid:logo@company" width="160" height="40" alt="Company Logo" />
          </div>
        </td>
      </tr></table>
    </div>

    <textarea id="htmlView" class="hidden" spellcheck="false"></textarea>

    <div class="status" id="status">Ready.</div>
  </div>

  <!-- Drawer for per-image actions -->
  <div id="drawer" class="drawer" aria-hidden="true">
    <div class="head">
      <strong>Images in document</strong>
      <div>
        <button class="btn" id="btnCloseDrawer">Close</button>
      </div>
    </div>
    <div class="body" id="imagesList"></div>
  </div>

<script>
const editor = document.getElementById('editor');
const htmlView = document.getElementById('htmlView');
const statusEl = document.getElementById('status');
const drawer = document.getElementById('drawer');
const imagesList = document.getElementById('imagesList');

function setStatus(msg){ statusEl.textContent = msg; }

// Toggle HTML view
document.getElementById('btnToggle').addEventListener('click', () => {
  const showing = !htmlView.classList.contains('hidden');
  if (showing){
    editor.innerHTML = htmlView.value; htmlView.classList.add('hidden'); editor.classList.remove('hidden'); setStatus('WYSIWYG mode.');
  } else {
    htmlView.value = editor.innerHTML; editor.classList.add('hidden'); htmlView.classList.remove('hidden'); setStatus('HTML mode.');
  }
});

// Export
document.getElementById('btnExport').addEventListener('click', () => {
  const html = editor.innerHTML.trim();
  const blob = new Blob([html], {type:'text/html;charset=utf-8'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'signature.html'; a.click(); setStatus('Exported signature.html');
});

// Simplify styles
document.getElementById('btnSimplify').addEventListener('click', () => {
  editor.querySelectorAll('*').forEach(el => {
    [...el.attributes].forEach(attr => { if(!/^(style|href|src|width|height|alt|cellpadding|cellspacing|border)$/i.test(attr.name)) el.removeAttribute(attr.name); });
  });
  setStatus('Simplified attributes.');
});

// Create placeholder element with same box size
function makePlaceholder(w,h,alt){
  const span = document.createElement('span');
  span.className = 'placeholder';
  span.setAttribute('data-ph', '1');
  if (alt) span.setAttribute('data-alt', alt);
  span.setAttribute('style', `width:${w}px;height:${h}px`);
  span.innerHTML = `<div>Image placeholder</div><div class="meta">${w}×${h}px${alt? ' · '+escapeHtml(alt):''}</div>`;
  return span;
}

function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

// Strip ALL images → placeholders
document.getElementById('btnStripAll').addEventListener('click', () => {
  const imgs = [...editor.querySelectorAll('img')];
  imgs.forEach(img => {
    const w = img.width || img.getAttribute('width') || img.naturalWidth || 120;
    const h = img.height || img.getAttribute('height') || img.naturalHeight || 60;
    const ph = makePlaceholder(Number(w), Number(h), img.alt || '');
    img.replaceWith(ph);
  });
  setStatus(`Replaced ${imgs.length} image(s) with placeholders.`);
});

// Drawer with per-image actions
function openDrawer(){ drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false'); refreshImagesList(); }
function closeDrawer(){ drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); }

document.getElementById('btnImagesPanel').addEventListener('click', openDrawer);

document.getElementById('btnCloseDrawer').addEventListener('click', closeDrawer);

function refreshImagesList(){
  imagesList.innerHTML = '';
  const all = [...editor.querySelectorAll('img, .placeholder[data-ph]')];
  if (all.length === 0){ imagesList.innerHTML = '<div class="small">No images or placeholders detected.</div>'; return; }

  all.forEach((el, idx) => {
    const isPh = el.matches('.placeholder');
    const w = isPh ? px(el.style.width) : (el.width || el.naturalWidth || 0);
    const h = isPh ? px(el.style.height) : (el.height || el.naturalHeight || 0);
    const src = isPh ? '(placeholder)' : (el.getAttribute('src')||'');
    const alt = isPh ? (el.getAttribute('data-alt')||'') : (el.alt||'');

    const row = document.createElement('div'); row.className = 'imgrow';
    const thumb = document.createElement(isPh ? 'div' : 'img');
    if (isPh){ thumb.className='thumb'; thumb.style.background='repeating-linear-gradient(45deg, #1b1c25 0 10px, #161821 10px 20px)'; }
    else { thumb.className='thumb'; thumb.src = el.src; }

    const info = document.createElement('div');
    info.innerHTML = `<div class="small">${isPh?'Placeholder':'Image'} · ${w}×${h}px</div>`+
                     `<div class="small" style="opacity:.8;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">src: ${escapeHtml(src)}</div>`;

    const actions = document.createElement('div');
    actions.style.display='grid'; actions.style.gap='6px'; actions.style.gridTemplateColumns='1fr';

    // Replace source URL (does not change box size)
    const replaceWrap = document.createElement('div'); replaceWrap.className='field';
    const url = document.createElement('input'); url.type='url'; url.placeholder='https://example.com/logo.png'; url.value = isPh ? '' : src;
    const btnApply = document.createElement('button'); btnApply.className='btn primary'; btnApply.textContent='Replace src';
    btnApply.addEventListener('click', () => {
      if (!url.value) return;
      const img = document.createElement('img');
      img.alt = alt; img.src = url.value; img.width = w; img.height = h; img.style.cssText = `display:block;width:${w}px;height:${h}px;border:0;outline:0;text-decoration:none;`;
      el.replaceWith(img); refreshImagesList(); setStatus('Replaced image source.');
    });
    replaceWrap.append(url, btnApply);

    // Strip/restore toggle for this element
    const btnToggle = document.createElement('button'); btnToggle.className='btn'; btnToggle.textContent = isPh ? 'Restore to <img>' : 'Strip → placeholder';
    btnToggle.addEventListener('click', () => {
      if (isPh){
        const img = document.createElement('img');
        img.alt = alt; img.src = ''; img.width = w; img.height = h; img.style.cssText = `display:block;width:${w}px;height:${h}px;border:0;outline:0;text-decoration:none;`;
        el.replaceWith(img);
      } else {
        const ph = makePlaceholder(w,h,alt); el.replaceWith(ph);
      }
      refreshImagesList(); setStatus('Toggled element.');
    });

    // File upload to replace source (keeps size)
    const upload = document.createElement('input'); upload.type='file'; upload.accept='image/*'; upload.className='small';
    upload.addEventListener('change', () => {
      const f = upload.files[0]; if(!f) return; const r = new FileReader();
      r.onload = () => { const img = document.createElement('img'); img.src = r.result; img.alt = alt; img.width = w; img.height = h; img.style.cssText=`display:block;width:${w}px;height:${h}px;border:0;outline:0;text-decoration:none;`; el.replaceWith(img); refreshImagesList(); setStatus(`Replaced with ${f.name}`);} ;
      r.readAsDataURL(f);
    });

    actions.append(replaceWrap, btnToggle, upload);
    row.append(thumb, info, actions);
    imagesList.append(row);
  });
}

function px(val){ return Number(String(val).replace('px','')) || 0; }

// Utility: clicking a placeholder in editor opens replacement panel quickly
editor.addEventListener('click', (e) => {
  const el = e.target.closest('img, .placeholder[data-ph]');
  if (!el) return; openDrawer();
  // scroll to the clicked element inside the list
  setTimeout(() => {
    const entries = [...imagesList.children];
    const idx = [...editor.querySelectorAll('img, .placeholder[data-ph]')].indexOf(el);
    if (entries[idx]) entries[idx].scrollIntoView({behavior:'smooth', block:'center'});
  }, 60);
});
</script>
</body>
</html>
