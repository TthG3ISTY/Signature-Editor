<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Signature Editor v5 – Rip + Size‑Lock</title>
  <style>
    :root { --bg:#0b0c10; --fg:#e8e8ea; --muted:#a2a2aa; --accent:#7aa2f7; --panel:#15151c; --border:#23232d; --on:#1b275a; --on-border:#3b4b84; }
    html,body{height:100%}
    body{margin:0;font:14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, sans-serif;background:var(--bg);color:var(--fg)}
    .wrap{max-width:1060px;margin:32px auto;padding:0 16px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;background:var(--panel);border:1px solid var(--border);border-bottom:none;border-radius:12px 12px 0 0;padding:12px}
    .btn{appearance:none;border:1px solid var(--border);background:#0f1016;color:var(--fg);padding:8px 10px;border-radius:9px;cursor:pointer}
    .btn:hover{border-color:#3b3c4d}
    .btn.on{background:var(--on);border-color:var(--on-border)}
    .sep{width:1px;height:28px;background:var(--border);margin:0 6px}
    .editor{min-height:320px;background:#0f1016;border:1px solid var(--border);border-radius:0 0 12px 12px;padding:16px;outline:none}
    .editor img{display:block;border:0;outline:0;text-decoration:none;-ms-interpolation-mode:bicubic}
    .editor img[data-locked="1"]{user-select:none;pointer-events:auto}
    .placeholder{display:block;box-sizing:border-box;background:repeating-linear-gradient(45deg, #1b1c25 0 10px, #161821 10px 20px);border:1px dashed #444;color:#c9c9cf;padding:6px;font:12px/1.2 Arial, Helvetica, sans-serif;text-align:center}
    .placeholder .meta{opacity:.8;font-size:11px}
    .small{font-size:12px;color:var(--muted)}
    #htmlView{width:100%;height:320px;resize:vertical;background:#0f1016;color:var(--fg);border:1px solid var(--border);border-radius:0 0 12px 12px;padding:16px}
    .hidden{display:none}
    .status{color:var(--muted);font-size:12px;margin-top:8px}
    .drawer{position:fixed;inset:auto 0 0 0;background:var(--panel);border-top:1px solid var(--border);transform:translateY(100%);transition:transform .25s ease;box-shadow:0 -12px 40px rgba(0,0,0,.5)}
    .drawer.open{transform:translateY(0)}
    .drawer .head{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border)}
    .drawer .body{max-height:40vh;overflow:auto;padding:12px 16px}
    .imgrow{display:grid;grid-template-columns:64px 1fr auto;gap:12px;align-items:center;padding:8px 0;border-bottom:1px solid #1f2030}
    .thumb{width:64px;height:48px;object-fit:contain;background:#0f1016;border:1px solid #1f2030;border-radius:6px}
    .field{display:flex;gap:6px;align-items:center}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 style="margin:0 0 10px">Signature Editor v5</h1>
    <p class="small" style="margin:0 0 12px">New: dedicated <strong>Rip + Lock selected</strong> button to flatten an image to inline PNG and hard‑lock its size. Also adds <em>Lock</em>/<em>Unlock</em> utilities and a guard that auto‑reverts any sneaky resize.</p>

    <div class="toolbar" role="toolbar">
      <button class="btn" id="btnRipLockSelected">Rip + Lock selected</button>
      <button class="btn" id="btnLockSelected">Lock selected</button>
      <button class="btn" id="btnUnlockSelected">Unlock selected</button>
      <span class="sep"></span>
      <button class="btn" id="btnRipAll">Rip ALL → inline</button>
      <span class="sep"></span>
      <button class="btn" id="btnStripAll">Strip all → placeholders</button>
      <button class="btn" id="btnImagesPanel">Manage images…</button>
      <span class="sep"></span>
      <button class="btn" id="btnToggle">HTML</button>
      <button class="btn" id="btnExport">Export</button>
    </div>

    <div id="editor" class="editor" contenteditable="true">
      <table cellpadding="0" cellspacing="0" role="presentation" style="border-collapse:collapse"><tr>
        <td style="font:14px/1.35 Arial, Helvetica, sans-serif;color:#222">
          <div style="font-weight:700">Your Name</div>
          <div style="color:#666">Title · Company</div>
          <div>
            <img src="cid:logo@company" width="160" height="40" alt="Company Logo" />
          </div>
        </td>
      </tr></table>
    </div>

    <textarea id="htmlView" class="hidden" spellcheck="false"></textarea>

    <div class="status" id="status">Ready.</div>
  </div>

  <div id="drawer" class="drawer" aria-hidden="true">
    <div class="head">
      <strong>Images & Placeholders</strong>
      <div><button class="btn" id="btnCloseDrawer">Close</button></div>
    </div>
    <div class="body" id="imagesList"></div>
  </div>

<script>
const editor = document.getElementById('editor');
const htmlView = document.getElementById('htmlView');
const statusEl = document.getElementById('status');
const drawer = document.getElementById('drawer');
const imagesList = document.getElementById('imagesList');

function setStatus(msg){ statusEl.textContent = msg; }

/* HTML toggle & Export */
document.getElementById('btnToggle').addEventListener('click', () => {
  const showing = !htmlView.classList.contains('hidden');
  if (showing){ editor.innerHTML = htmlView.value; htmlView.classList.add('hidden'); editor.classList.remove('hidden'); }
  else { htmlView.value = editor.innerHTML; editor.classList.add('hidden'); htmlView.classList.remove('hidden'); }
});

document.getElementById('btnExport').addEventListener('click', () => {
  const html = editor.innerHTML.trim();
  const blob = new Blob([html], {type:'text/html;charset=utf-8'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'signature.html'; a.click(); setStatus('Exported signature.html');
});

/* Utilities */
function dimsOf(el){ return { w: el.width || Number(el.getAttribute('width')) || el.naturalWidth || 0, h: el.height || Number(el.getAttribute('height')) || el.naturalHeight || 0 }; }
function selectTarget(){ const sel = getSelection(); const n = sel && sel.anchorNode ? (sel.anchorNode.nodeType===1? sel.anchorNode : sel.anchorNode.parentElement) : null; return n && n.closest('img, .placeholder[data-ph]'); }

/* Lock/Unlock size */
function lockImage(img){ if (!img || img.tagName!=='IMG') return; const {w,h}=dimsOf(img); if(!w||!h) return; img.width=w; img.height=h; img.style.width=w+'px'; img.style.height=h+'px'; img.setAttribute('data-locked','1'); img.setAttribute('draggable','false'); img.setAttribute('contenteditable','false'); }
function unlockImage(img){ if (!img || img.tagName!=='IMG') return; img.removeAttribute('data-locked'); img.removeAttribute('contenteditable'); }

document.getElementById('btnLockSelected').addEventListener('click', () => { const el=selectTarget(); if(el && el.tagName==='IMG'){ lockImage(el); setStatus('Locked size for selected image.'); } else setStatus('Select an image first.'); });

document.getElementById('btnUnlockSelected').addEventListener('click', () => { const el=selectTarget(); if(el && el.tagName==='IMG'){ unlockImage(el); setStatus('Unlocked size for selected image.'); } else setStatus('Select an image first.'); });

/* Rip image to inline and then lock */
document.getElementById('btnRipLockSelected').addEventListener('click', async () => {
  const el = selectTarget();
  if (!el || el.tagName!=='IMG'){ setStatus('Select an image first.'); return; }
  const {w,h} = dimsOf(el); const ok = await ripElementToInline(el, w, h, el.alt||'');
  if (ok){ lockImage(el.parentElement ? el.parentElement.querySelector('img[src^="data:"]') || el : el); setStatus('Ripped to inline + size‑locked.'); refreshImagesList(); }
  else setStatus('Could not rip (cross‑origin/CID). Try upload replace.');
});

/* Rip ALL */
document.getElementById('btnRipAll').addEventListener('click', async () => {
  const imgs=[...editor.querySelectorAll('img')]; let ok=0; for(const el of imgs){ const {w,h}=dimsOf(el); const alt=el.alt||''; const done=await ripElementToInline(el,w,h,alt); if(done){ lockImage(el); ok++; } } setStatus(`Ripped + locked ${ok} image(s).`); refreshImagesList();
});

/* Placeholder strip all */
document.getElementById('btnStripAll').addEventListener('click', () => {
  const imgs = [...editor.querySelectorAll('img')];
  imgs.forEach(img => { const w = img.width || img.naturalWidth || 120; const h = img.height || img.naturalHeight || 60; const ph = document.createElement('span'); ph.className='placeholder'; ph.setAttribute('data-ph','1'); ph.style.width=w+'px'; ph.style.height=h+'px'; ph.innerHTML = `<div>Image placeholder</div><div class="small">${w}×${h}px</div>`; img.replaceWith(ph); });
  setStatus(`Replaced ${imgs.length} image(s) with placeholders.`);
});

/* Drawer */
function openDrawer(){ drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false'); refreshImagesList(); }
function closeDrawer(){ drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); }
document.getElementById('btnImagesPanel').addEventListener('click', openDrawer);
document.getElementById('btnCloseDrawer').addEventListener('click', closeDrawer);

function refreshImagesList(){
  imagesList.innerHTML='';
  const all=[...editor.querySelectorAll('img, .placeholder[data-ph]')];
  if(all.length===0){ imagesList.innerHTML='<div class="small">No images or placeholders detected.</div>'; return; }
  all.forEach(el=>{
    const isPh = el.classList.contains('placeholder');
    const w = isPh ? Number(el.style.width.replace('px','')) : (el.width||el.naturalWidth||0);
    const h = isPh ? Number(el.style.height.replace('px','')) : (el.height||el.naturalHeight||0);
    const src = isPh ? '(placeholder)' : (el.getAttribute('src')||'');
    const row=document.createElement('div'); row.className='imgrow';
    const thumb=document.createElement(isPh?'div':'img'); if(isPh){ thumb.className='thumb'; thumb.style.background='repeating-linear-gradient(45deg,#1b1c25 0 10px,#161821 10px 20px)'; } else { thumb.className='thumb'; thumb.src=src; }
    const info=document.createElement('div'); info.innerHTML=`<div class="small">${isPh?'Placeholder':'Image'} · ${w}×${h}px ${!isPh && el.dataset.locked==='1'?'· locked':''}</div><div class="small" style="opacity:.8;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">src: ${src}</div>`;
    const actions=document.createElement('div'); actions.style.display='grid'; actions.style.gap='6px';
    if(!isPh){
      const lockBtn=document.createElement('button'); lockBtn.className='btn'; lockBtn.textContent = el.dataset.locked==='1'?'Unlock':'Lock size'; lockBtn.addEventListener('click',()=>{ if(el.dataset.locked==='1'){ unlockImage(el); } else { lockImage(el); } refreshImagesList(); });
      actions.append(lockBtn);
    }
    row.append(thumb,info,actions); imagesList.append(row);
  });
}

/* Rip to inline helper */
async function ripElementToInline(imgEl,w,h,alt){
  try{ const img = new Image(); img.crossOrigin='anonymous'; img.src = imgEl.src; await imgDecode(img); const c=document.createElement('canvas'); c.width=w; c.height=h; const ctx=c.getContext('2d'); ctx.imageSmoothingEnabled=true; ctx.imageSmoothingQuality='high'; ctx.drawImage(img,0,0,w,h); const data=c.toDataURL('image/png'); imgEl.src=data; imgEl.width=w; imgEl.height=h; imgEl.style.width=w+'px'; imgEl.style.height=h+'px'; return true; }catch(e){ return false; }
}
function imgDecode(img){ return new Promise((res,rej)=>{ img.onload=()=>res(); img.onerror=rej; }); }

/* Guard: if a locked image gets resized, revert it */
const guard = new MutationObserver(muts=>{
  for(const m of muts){
    if(m.type==='attributes' && m.target.tagName==='IMG' && m.target.dataset.locked==='1'){
      const img=m.target; const w=Number(img.getAttribute('width')); const h=Number(img.getAttribute('height'));
      if(img.style.width!==w+'px') img.style.width=w+'px';
      if(img.style.height!==h+'px') img.style.height=h+'px';
    }
  }
});

guard.observe(editor,{subtree:true,attributes:true,attributeFilter:['style','width','height','data-locked']});

/* Click-to-open drawer at element */
editor.addEventListener('click', e=>{ const el=e.target.closest('img, .placeholder[data-ph]'); if(!el) return; openDrawer(); setTimeout(()=>{ const entries=[...imagesList.children]; const idx=[...editor.querySelectorAll('img, .placeholder[data-ph]')].indexOf(el); if(entries[idx]) entries[idx].scrollIntoView({behavior:'smooth',block:'center'}); },50); });
</script>
</body>
</html>
